<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Min Portfolio</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <h1>Portfolio-indl√¶g</h1>
            <div id="auth-controls">
            </div>
        </div>
        <div id="filter-controls"><div><label for="search-input">S√∏g</label><input type="search" id="search-input" placeholder="Indtast s√∏geord"></div><div><label for="filter-subject">Filtr√©r efter fag</label><select id="filter-subject"><option value="all">Alle fag</option><option value="Cyber Security">Cyber Security</option><option value="Appudvikling">Appudvikling</option><option value="Andet">Andet</option></select></div><div><label for="start-date">Startdato</label><input type="date" id="start-date"></div><div><label for="end-date">Slutdato</label><input type="date" id="end-date"></div></div>

        <div id="backup-controls">
            <h2>Backup af Data</h2>
            <div>
                <button id="export-btn">Eksporter Alle Indl√¶g</button>
            </div>
            <div id="import-form">
                <input type="file" id="import-file" accept=".json">
                <button id="import-btn">Importer Fra Fil</button>
            </div>
        </div>

        <div id="portfolio-list"></div>
    </div>

    <script type="module">
        import { formatDate, getSubjectIcon, typeTranslations } from './main.js';

        document.addEventListener('DOMContentLoaded', () => {
            const portfolioList = document.getElementById('portfolio-list');
            const searchInput = document.getElementById('search-input');
            const filterSubject = document.getElementById('filter-subject');
            const startDateFilter = document.getElementById('start-date');
            const endDateFilter = document.getElementById('end-date');
            const authControls = document.getElementById('auth-controls');
            const backupControls = document.getElementById('backup-controls');
            let portfolioEntries = [];
            const token = localStorage.getItem('accessToken');

            // This will now work correctly
            if (backupControls) {
                backupControls.style.display = 'none';
            }

            // This will also work correctly
            if (token) {
                authControls.innerHTML = `
                    <a href="create.html" class="create-btn" style="margin-left: 10px;">Opret Nyt Indl√¶g</a>
                    <button id="logout-btn" class="action-button delete-btn" style="margin-left: 10px; width: auto;">Log Ud</button>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => {
                    localStorage.removeItem('accessToken');
                    location.reload();
                });
            } else {
                authControls.innerHTML = '<a href="login.html" class="create-btn">Login</a>';
            }

            const apiBaseUrl = 'https://api.longmose-portfolio.duckdns.org/api';

            const fetchEntries = async () => {
                try {
                    const response = await fetch(`${apiBaseUrl}/posts`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    portfolioEntries = await response.json();
                    renderEntries();
                } catch (error) {
                    console.error('Fetch error:', error);
                    portfolioList.innerHTML = '<p>Error loading portfolio entries. Make sure the backend is running.</p>';
                }
            };

            const renderEntries = () => {
                const filteringLogic = entry => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const selectedSubject = filterSubject.value;
                    const startDate = startDateFilter.value;
                    const endDate = endDateFilter.value;
                    const matchesSearch = searchTerm === '' || entry.title.toLowerCase().includes(searchTerm) || entry.goal.toLowerCase().includes(searchTerm) || (entry.description && entry.description.toLowerCase().includes(searchTerm));
                    const matchesSubject = selectedSubject === 'all' || entry.subject === selectedSubject;
                    const entryDate = new Date(entry.date).toISOString().split('T')[0];
                    const matchesDate = (!startDate || entryDate >= startDate) && (!endDate || entryDate <= endDate);
                    return matchesSearch && matchesSubject && matches.
                };

                const filteredEntries = portfolioEntries.filter(filteringLogic).sort((a, b) => new Date(b.date) - new Date(a.date));
                portfolioList.innerHTML = filteredEntries.length === 0 ? '<p>Ingen indl√¶g fundet, der matcher dine kriterier.</p>' : '';

                filteredEntries.forEach(entry => {
                    const entryElement = document.createElement('div');
                    entryElement.classList.add('portfolio-entry');
                    entryElement.setAttribute('data-id', entry.id);
                    const editButtonHtml = token ? `<a href="edit.html?id=${entry.id}" class="edit-btn" title="Rediger Indl√¶g">Rediger</a>` : '';

                    entryElement.innerHTML = `
                        <div class="entry-header">
                            <div class="entry-header-info">
                                <h3>${entry.title}</h3>
                                <div class="entry-meta">
                                    <span>üìÖ ${formatDate(new Date(entry.date).toISOString().split('T')[0])}</span>
                                    <span>${getSubjectIcon(entry.subject)} ${entry.subject}</span>
                                </div>
                                <div class="entry-goal">
                                    <div class="entry-section-title">M√•l</div>
                                    <p>${entry.goal.replace(/\n/g, '<br>')}</p>
                                </div>
                            </div>
                        </div>
                        <div class="entry-details">
                            ${entry.description ? `<div class="entry-section-title">Beskrivelse</div><p>${entry.description.replace(/\n/g, '<br>')}</p>` : ''}
                            ${entry.code ? `<button class="toggle-btn toggle-content-btn" data-type="code">Vis ${typeTranslations.code}</button><div class="collapsible-content" data-type="code"><pre><code>${entry.code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code></pre></div>` : ''}
                            ${entry.picture ? `<button class="toggle-btn toggle-content-btn" data-type="picture">Vis ${typeTranslations.picture}</button><div class="collapsible-content" data-type="picture"><img src="${entry.picture}" alt="${entry.title} Picture"></div>` : ''}
                            ${entry.video ? `<button class="toggle-btn toggle-content-btn" data-type="video">Vis ${typeTranslations.video}</button><div class="collapsible-content" data-type="video"><video controls src="${entry.video}"></video></div>` : ''}
                        </div>
                        <div class="entry-actions">${editButtonHtml}</div>`;
                    portfolioList.appendChild(entryElement);
                });
            };

            portfolioList.addEventListener('click', (e) => {
                const target = e.target;
                const entryElement = target.closest('.portfolio-entry');
                if (!entryElement) return;

                if (target.closest('.toggle-content-btn')) {
                    const type = target.dataset.type;
                    const content = entryElement.querySelector(`.collapsible-content[data-type="${type}"]`);
                    content.classList.toggle('visible');
                    // *** SYNTAX FIX HERE ***
                    target.textContent = content.classList.contains('visible') ?\`Skjul \${typeTranslations[type]}\` : \`Vis \${typeTranslations[type]}\`;
                    return;
                }

                if (!target.closest('a, button')) {
                    const details = entryElement.querySelector('.entry-details');
                    const isExpanded = details.style.height && details.style.height !== '0px';
                    // *** SYNTAX FIX HERE ***
                    details.style.height = isExpanded ? '0px' : \`\${details.scrollHeight}px\`;
                }
            });

            startDateFilter.addEventListener('change', renderEntries);
            endDateFilter.addEventListener('change', renderEntries);
            searchInput.addEventListener('input', renderEntries);
            filterSubject.addEventListener('change', renderEntries);

            fetchEntries();
        });
    </script>
</body>
</html>